name: CMake CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: ${{ matrix.workflow }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC workflows
          - workflow: gcc-17-all
            os: ubuntu-latest
            compiler: gcc
          - workflow: gcc-23-all
            os: ubuntu-latest
            compiler: gcc
          - workflow: gcc-latest-all
            os: ubuntu-latest
            compiler: gcc
          
          # Clang workflows
          - workflow: clang-17-all
            os: ubuntu-latest
            compiler: clang
          - workflow: clang-23-all
            os: ubuntu-latest
            compiler: clang
          - workflow: clang-latest-all
            os: ubuntu-latest
            compiler: clang
          
          # Sanitizer workflows
          - workflow: clang-latest-asan
            os: ubuntu-latest
            compiler: clang
          - workflow: clang-latest-tsan
            os: ubuntu-latest
            compiler: clang
          
          # Coverage workflow
          - workflow: clang-latest-coverage
            os: ubuntu-latest
            compiler: clang
            extra: llvm
          
          # Static analysis workflow
          - workflow: clang-latest-tidy
            os: ubuntu-latest
            compiler: clang
            extra: clang-tidy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake ${{ matrix.compiler }} ${{ matrix.extra }}

      - name: Install Java (for TLA+ verification)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: |
            build
            external
          key: ${{ runner.os }}-cmake-${{ matrix.workflow }}-${{ hashFiles('**/CMakeLists.txt', '**/CMakePresets.json') }}
          restore-keys: |
            ${{ runner.os }}-cmake-${{ matrix.workflow }}-
            ${{ runner.os }}-cmake-

      - name: Run CMake workflow
        run: cmake --workflow --preset ${{ matrix.workflow }}

      - name: Upload coverage report
        if: matrix.workflow == 'clang-latest-coverage'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/clang-latest-coverage/coverage_report/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.workflow }}
          path: build/**/Testing/
          retention-days: 7
          if-no-files-found: ignore

  verify-tla:
    name: TLA+ Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: |
            build
            external
          key: ${{ runner.os }}-cmake-verify-${{ hashFiles('**/CMakeLists.txt', '**/CMakePresets.json') }}
          restore-keys: |
            ${{ runner.os }}-cmake-verify-

      - name: Configure CMake
        run: cmake --preset clang-latest

      - name: Run TLC verification
        run: cmake --build --preset clang-latest-debug --target verify-tlc

      - name: Run Apalache verification
        run: cmake --build --preset clang-latest-debug --target verify-apalache
        continue-on-error: true

  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [build-and-test, verify-tla]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "Build and test failed"
            exit 1
          fi
          if [ "${{ needs.verify-tla.result }}" != "success" ]; then
            echo "TLA+ verification failed"
            exit 1
          fi
          echo "All checks passed!"
